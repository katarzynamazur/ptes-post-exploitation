#!/bin/bash

#
# PTES 3.2.4
# In todays network many services and operating systems use a number of protocols for neighbor discovery in an effort make the access of services, troubleshooting and configuration more convenient. Protocols vary depending on the type of target host. Networking equipment may use protocols like CDP (Cisco Discovery Protocol) and LLDP (Link Layer Discovery Protocol) to identify systems, configurations and other details to hosts directly connected to them or present in the same subnet. Similarly, desktop and server operating systems may use protocols like mDNS (Multicast Domain Name Service) and NetBios to find details of hosts and services in the same subnet. 
#

exists()
{
  command -v "$1" >/dev/null 2>&1
}

print_newline()
{
    for i in {0..80}
    do
        echo -ne "\e[00;90m#"
    done
    echo "" 
}

output=$1
print_newline > $output  
###############################################################################################
if [ $# -eq 0 ]
  then
    echo "No arguments supplied"
    exit 1
fi
###############################################################################################
# CDP stands for Cisco Discovery Protocol, which is a layer 2 protocol and is used to 
# share information about other directly connected Cisco equipment
# run tcpdump for 60 seconds and filter CDP protocol
if exists tcpdump; then
    sudo tcpdump -nn -v -G 60 -W 1 -s 1500 -c 1 'ether[20:2] == 0x2000' -w ptes324cdp.pcap -Z root
    tcpdump1=`sudo tcpdump -ttttnnr ptes324cdp.pcap`
    echo -e "\e[00;31m[-] CDP details:\e[00m\n$tcpdump1"  >> $output 
    print_newline >> $output  
else
  echo 'Your OS does not have tcpdump'
fi
###############################################################################################
if exists tcpdump; then
    sudo tcpdump -nn -v -XX -G 60 -W 1 -s 1500 -c 1 'ether[20:2] == 0x2000' -w ptes324cdpXX.pcap -Z root
    tcpdump2=`sudo tcpdump -ttttnnr ptes324cdpXX.pcap`
    echo -e "\e[00;31m[-] CDP details:\e[00m\n$tcpdump2"  >> $output 
    print_newline >> $output  
else
  echo 'Your OS does not have tcpdump'
fi
###############################################################################################
# LLDP stands for Link Layer Discovery Protocol and replaces CDP.  LLDP is a vendor neutral 
# Data Link Layer protocol used by network devices for advertising of their 
# identity, capabilities and neighbours
# run tcpdump for 60 seconds and filter LLDP protocol
if exists tcpdump; then
    sudo tcpdump -nn -v -G 60 -W 1 -s 1500 -c 1 'ether[12:2]=0x88cc' -w ptes324lldp.pcap -Z root
    tcpdump3=`sudo tcpdump -ttttnnr ptes324lldp.pcap`
    echo -e "\e[00;31m[-] LLDP details:\e[00m\n$tcpdump3"  >> $output 
    print_newline >> $output  
else
  echo 'Your OS does not have tcpdump'
fi
###############################################################################################
if exists tcpdump; then
    sudo tcpdump -nn -v -XX -G 60 -W 1 -s 1500 -c 1 'ether[12:2]=0x88cc' -w ptes324lldpXX.pcap -Z root
    tcpdump4=`sudo tcpdump -ttttnnr ptes324lldpXX.pcap`
    echo -e "\e[00;31m[-] LLDP details:\e[00m\n$tcpdump4"  >> $output 
    print_newline >> $output  
else
  echo 'Your OS does not have tcpdump'
fi
###############################################################################################
cat $output
