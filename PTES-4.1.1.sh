#!/bin/bash

#
# PTES 4.1.1
# Most systems will have applications that can run at system startup or at user logon that can provide information about the purpose of the system, software and services it interacts with. This information may reveal potential countermeasures that could be in place that may hinder further exploitation of a target network and itâ€™s systems (e.g. HIDS/HIPS, Application Whitelisting, FIM). Information that should be gathered includes:

#  -  List of the applications and their associated versions installed on the system.
#  -  List of operating system updates applied to the system.
#

exists()
{
  command -v "$1" >/dev/null 2>&1
}

print_newline()
{
    for i in {0..80}
    do
        echo -ne "\e[00;90m#"
    done
    echo "" 
}

install_software() 
{
    sudo apt-get update && apt-get upgrade
    
    # systemctl
    sudo apt-get install systemd -y
}

systemctl_startup_services_check()
{
    if exists systemctl; then
        systemctl1=`systemctl list-units --type=service`
        echo -e "\e[00;31m[-] Startup services: \e[00m\n$systemctl1"  >> $output 
        print_newline >> $output  
    else
      echo 'Your OS does not have systemctl'
    fi
    
    if exists systemctl; then
        systemctl2=`systemctl list-unit-files --type=service` 
        echo -e "\e[00;31m[-] Startup services: \e[00m\n$systemctl2"  >> $output 
        print_newline >> $output  
    else
      echo 'Your OS does not have systemctl'
    fi
    
    if exists systemctl; then
        systemctl3=`sudo systemctl list-unit-files --type=service --state=enabled --all`
        echo -e "\e[00;31m[-] Startup services: \e[00m\n$systemctl3"  >> $output 
        print_newline >> $output  
    else
      echo 'Your OS does not have systemctl'
    fi
}

conf_files_startup_services_check()
{
    ls1=`ls /etc/init.d`
    echo -e "\e[00;31m[-] Startup services: \e[00m\n$ls1"  >> $output 
    print_newline >> $output 
    
    ls2=`ls -1 /lib/systemd/system/*.service /etc/systemd/system/*.service`
    echo -e "\e[00;31m[-] Startup services: \e[00m\n$ls2"  >> $output 
    print_newline >> $output
}

recently_installed_packages_check()
{
    packages1=`grep " install " /var/log/dpkg.log`
    echo -e "\e[00;31m[-] Recently installed packages: \e[00m\n$packages1"  >> $output 
    print_newline >> $output 
}

all_installed_packages()
{
    packages2=`sudo apt list --installed | less`
    echo -e "\e[00;31m[-] All installed packages: \e[00m\n$packages2"  >> $output 
    print_newline >> $output 
}

upgradeable_packages()
{
    packages3=`sudo apt list --upgradeable`
    echo -e "\e[00;31m[-] Upgradeable packages: \e[00m\n$packages3"  >> $output 
    print_newline >> $output 
}

ptes411()
{
    systemctl_startup_services_check
    conf_files_startup_services_check
    recently_installed_packages_check
    all_installed_packages
    upgradeable_packages
}

if [ $# -eq 0 ]
    then
        echo "No arguments supplied"
        exit 1
fi

output=$1
print_newline > $output   
install_software  
ptes411
cat $output
