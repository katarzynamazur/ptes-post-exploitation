#!/bin/bash

#
# PTES 4.1.2
# Installed Services
# Services on a particular host may serve the host itself, or other hosts in the target network. It is necessary to create a profile of each targeted host, noting the configuration of these services, their purpose, and how they may potentially be used to achieve assessment goals or further penetrate the network. 
#

exists()
{
  command -v "$1" >/dev/null 2>&1
}

print_newline()
{
    for i in {0..80}
    do
        echo -ne "\e[00;90m#"
    done
    echo "" 
}

install_software() 
{
    sudo apt-get update && apt-get upgrade
    
    # systemctl
    sudo apt-get install systemd -y
    
    # service
    sudo apt-get install sysvinit-utils -y
    
    # dpkg-query
    sudo apt-get install dpkg -y
}

systemctl_all_services_check()
{
    if exists systemctl; then
        systemctl1=`systemctl -at service`
        echo -e "\e[00;31m[-] All services: \e[00m\n$systemctl1"  >> $output 
        print_newline >> $output  
    else
      echo 'Your OS does not have systemctl'
    fi
    
    if exists systemctl; then
        service1=`service --status-all`
        echo -e "\e[00;31m[-] All running (+) / stopped (-) services: \e[00m\n$service1"  >> $output 
        print_newline >> $output  
    else
      echo 'Your OS does not have service'
    fi
}

systemctl_active_services_check()
{
    if exists systemctl; then
        systemctl2=`systemctl -t service --state=active`
        echo -e "\e[00;31m[-] All active services: \e[00m\n$systemctl2"  >> $output 
        print_newline >> $output  
    else
      echo 'Your OS does not have systemctl'
    fi
}

systemctl_loaded_services_check()
{
    if exists systemctl; then
        systemctl3=`systemctl list-units --type service`
        echo -e "\e[00;31m[-] All loaded services: \e[00m\n$systemctl3"  >> $output 
        print_newline >> $output  
    else
      echo 'Your OS does not have systemctl'
    fi
}

all_installed_packages()
{
    if exists apt; then
        apt1=`sudo apt list --installed | less`
        echo -e "\e[00;31m[-] All installed packages: \e[00m\n$apt1"  >> $output 
        print_newline >> $output  
    else
      echo 'Your OS does not have apt'
    fi
    
    if exists dpkg-query; then
        dpkgquery1=`sudo dpkg-query -l | less`
        echo -e "\e[00;31m[-] All installed packages: \e[00m\n$dpkgquery1"  >> $output 
        print_newline >> $output  
    else
      echo 'Your OS does not have dpkg-query'
    fi
}

ptes412()
{
    systemctl_all_services_check
    systemctl_active_services_check
    systemctl_loaded_services_check
    
    all_installed_packages
}

if [ $# -eq 0 ]
    then
        echo "No arguments supplied"
        exit 1
fi

output=$1
print_newline > $output   
install_software  
ptes412
cat $output
