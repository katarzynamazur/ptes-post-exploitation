#!/bin/bash

#
# PTES 3.2.3
# A targeted host running directory services may provide an opportunity to enumerate user accounts, hosts and/or services that can be used in additional attacks or provide additional targets that may not have been previously discovered in the vulnerability analysis phase. Additionally, the details of users found in directory services could be used for Social Engineering and phishing campaign attacks, thus providing a possible higher success rate. 
#

exists()
{
  command -v "$1" >/dev/null 2>&1
}

print_newline()
{
    for i in {0..80}
    do
        echo -ne "\e[00;90m#"
    done
    echo "" 
}

install_software() 
{
    sudo apt-get update && apt-get upgrade
    
    # route, arp
    sudo apt-get install net-tools -y
    
    # net manager
    sudo apt-get install network-manager -y
    sudo systemctl start NetworkManager.service 
    sudo systemctl enable NetworkManager.service
    
    # resolvectl, systemd-resolve 
    sudo apt-get install systemd -y
    
    # tcpdump
    sudo apt-get install tcpdump -y
    
    # rpcinfo
    sudo apt-get install rpcbind -y
}

uninstall_software()
{
    # net manager 
    sudo systemctl stop NetworkManager.service 
    sudo systemctl disable NetworkManager.service
    
    sudo systemctl stop NetworkManager-wait-online.service
    sudo systemctl disable NetworkManager-wait-online.service

    sudo systemctl stop NetworkManager-dispatcher.service
    sudo systemctl disable NetworkManager-dispatcher.service

    sudo systemctl stop network-manager.service
    sudo systemctl disable network-manager.service
    
    sudo apt-get purge network-manager
}

dns_check()
{
    # directory services - DNS
    if exists nmcli; then
      nmcli1=`( nmcli dev list || nmcli dev show ) 2>/dev/null | grep DNS`
        echo -e "\e[00;31m[-] DNS details:\e[00m\n$nmcli1"  >> $output 
        print_newline >> $output  
    else
      echo 'Your OS does not have nmcli'
    fi
    
    # directory services - DNS
    if exists systemd-resolve; then
      systemdresolve1=`systemd-resolve --status`
        echo -e "\e[00;31m[-] DNS details:\e[00m\n$systemdresolve1"  >> $output 
        print_newline >> $output  
    else
      echo 'Your OS does not have systemd-resolve'
    fi
    
    # directory services - DNS
    if exists systemd-resolve; then
      systemdresolve2=`systemd-resolve --status | grep DNS`
        echo -e "\e[00;31m[-] DNS details:\e[00m\n$systemdresolve2"  >> $output 
        print_newline >> $output  
    else
      echo 'Your OS does not have systemd-resolve'
    fi
    
    # directory services - DNS
    dns1=`cat /etc/resolv.conf |grep -i '^nameserver'|head -n1|cut -d ' ' -f2`
    echo -e "\e[00;31m[-] DNS details:\e[00m\n$systemdresolve2"  >> $output 
    print_newline >> $output  
    
    # directory services - DNS
    if exists resolvectl; then
      resolvectl1=`resolvectl status | grep -1 'DNS Server'`
        echo -e "\e[00;31m[-] DNS details:\e[00m\n$resolvectl1"  >> $output 
        print_newline >> $output  
    else
      echo 'Your OS does not have resolvectl'
    fi
    
    # directory services - DNS
    # run tcpdump on DNS port for 60 seconds
    if exists tcpdump; then
        sudo tcpdump -G 60 -W 1 port 53 -v -w ptes323dns.pcap -Z root
        tcpdump1=`sudo tcpdump -ttttnnr ptes323dns.pcap`
        echo -e "\e[00;31m[-] DNS details:\e[00m\n$tcpdump1"  >> $output 
        print_newline >> $output  
    else
      echo 'Your OS does not have tcpdump'
    fi
}

nis_check()
{
    # directory services - NIS
    # NIS server default ports are: 111 (TCP,UDP), 714 (TCP), 711 (UDP)
    if exists tcpdump; then
        sudo tcpdump -n -n -G 60 -W 1 port 111 or port 714 or port 711 -v -w ptes323nis.pcap -Z root
        tcpdump2=`sudo tcpdump -ttttnnr ptes323nis.pcap`
        echo -e "\e[00;31m[-] NIS details:\e[00m\n$tcpdump2"  >> $output 
        print_newline >> $output  
    else
      echo 'Your OS does not have tcpdump'
    fi
}

nfs_check()
{
    # directory services - NFS
    if exists rpcinfo; then
      rpcinfo1=`rpcinfo -p | grep nfs`
        echo -e "\e[00;31m[-] NFS details:\e[00m\n$rpcinfo1"  >> $output 
        print_newline >> $output  
    else
      echo 'Your OS does not have rpcinfo'
    fi
    
    # directory services - NFS
    if exists tcpdump; then
        sudo tcpdump -n -n -G 60 -W 1 port 2049 -v -w ptes323nfs.pcap -Z root
        tcpdump3=`sudo tcpdump -ttttnnr ptes323nfs.pcap`
        echo -e "\e[00;31m[-] NIS details:\e[00m\n$tcpdump3"  >> $output 
        print_newline >> $output  
    else
      echo 'Your OS does not have tcpdump'
    fi
}

ptes323()
{
    dns_check
    nis_check
    nfs_check
}

if [ $# -eq 0 ]
    then
        echo "No arguments supplied"
        exit 1
fi

output=$1
print_newline > $output   
install_software  
ptes323
cat $output
